{% extends 'base.html' %}

{% block title %}New Bill - Cosmic Surgical{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<style>
    /* Cart table styling */
    #cart-table { table-layout: fixed; }
    #cart-table tbody tr td { vertical-align: middle; padding: 0.5rem 0.4rem; }
    #cart-table input.form-control { padding: 0.25rem 0.4rem; font-size: 0.875rem; }
    #cart-table .btn-sm { padding: 0.2rem 0.4rem; }
    #cart-table td:first-child { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }

    /* Product search modal */
    #productSearchModal .modal-body { padding: 0; }
    #productSearchModal .search-input-container { padding: 15px; border-bottom: 1px solid #dee2e6; background: #f8f9fa; }
    #productSearchModal .product-list { max-height: 400px; overflow-y: auto; }
    #productSearchModal .product-item { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.15s; }
    #productSearchModal .product-item:hover { background: #e3f2fd; }
    #productSearchModal .product-item:last-child { border-bottom: none; }
    #productSearchModal .product-name { font-weight: 600; color: #333; }
    #productSearchModal .product-details { font-size: 0.85rem; color: #666; }
    #productSearchModal .product-price { font-weight: 600; color: #1976d2; }
    #productSearchModal .product-stock { font-size: 0.8rem; }
    #productSearchModal .stock-ok { color: #2e7d32; }
    #productSearchModal .stock-low { color: #f57c00; }
    #productSearchModal .stock-out { color: #c62828; }
    #productSearchModal .no-results { padding: 40px; text-align: center; color: #999; }

    /* Customer dropdown */
    .customer-dropdown { position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 200px; overflow-y: auto; }
    .customer-dropdown .customer-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
    .customer-dropdown .customer-item:hover { background: #f5f5f5; }
    .customer-dropdown .customer-item:last-child { border-bottom: none; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-cart-plus me-2"></i>New Bill</h2>
    <div>
        <span class="badge bg-primary fs-6">{{ next_invoice_number }}</span>
        <span class="badge bg-secondary fs-6 ms-2">{{ today }}</span>
    </div>
</div>

<div class="row">
    <!-- Left Column - Cart -->
    <div class="col-lg-8">
        <!-- Add Product Button & Barcode -->
        <div class="card mb-3">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#productSearchModal">
                            <i class="bi bi-plus-circle me-2"></i>Add Product (F2)
                        </button>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
                            <input type="text" class="form-control" id="barcode-input" placeholder="Scan barcode..." autocomplete="off">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cart Items -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-cart me-1"></i>Cart Items (<span id="item-count">0</span>)</span>
                <button type="button" class="btn btn-sm btn-outline-danger" id="clear-cart">
                    <i class="bi bi-trash me-1"></i>Clear
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle" id="cart-table">
                        <thead class="table-light">
                            <tr>
                                <th style="min-width: 180px;">Product</th>
                                <th style="width: 90px;">Qty</th>
                                <th style="width: 60px;">Unit</th>
                                <th style="width: 110px;">Rate</th>
                                <th style="width: 100px;" class="text-end">Taxable</th>
                                <th style="width: 70px;" class="text-center">GST</th>
                                <th style="width: 100px;" class="text-end">Total</th>
                                <th style="width: 45px;"></th>
                            </tr>
                        </thead>
                        <tbody id="cart-items">
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="bi bi-cart" style="font-size: 2rem;"></i>
                                    <p class="mb-0 mt-2">Cart is empty. Click "Add Product" or scan barcode.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column - Summary & Actions -->
    <div class="col-lg-4">
        <!-- Customer Selection -->
        <div class="card mb-3">
            <div class="card-header"><i class="bi bi-person me-1"></i>Customer</div>
            <div class="card-body">
                <div class="position-relative mb-2">
                    <input type="text" class="form-control" id="customer-search" placeholder="Search customer..." autocomplete="off">
                    <div id="customer-results" class="customer-dropdown" style="display: none;"></div>
                </div>
                <div id="selected-customer-info"></div>
                <small class="text-muted">Leave empty for Walk-in Customer</small>
            </div>
        </div>

        <!-- Bill Summary -->
        <div class="card mb-3">
            <div class="card-header"><i class="bi bi-calculator me-1"></i>Bill Summary</div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tr>
                        <td>Subtotal</td>
                        <td class="text-end">Rs. <span id="subtotal">0.00</span></td>
                    </tr>
                    <tr id="cgst-row">
                        <td>CGST</td>
                        <td class="text-end">Rs. <span id="cgst-total">0.00</span></td>
                    </tr>
                    <tr id="sgst-row">
                        <td>SGST</td>
                        <td class="text-end">Rs. <span id="sgst-total">0.00</span></td>
                    </tr>
                    <tr id="igst-row" style="display: none;">
                        <td>IGST</td>
                        <td class="text-end">Rs. <span id="igst-total">0.00</span></td>
                    </tr>
                    <tr>
                        <td>Discount</td>
                        <td class="text-end">
                            <div class="input-group input-group-sm" style="width: 100px; margin-left: auto;">
                                <span class="input-group-text">Rs.</span>
                                <input type="number" class="form-control text-end" id="discount-input" value="0" min="0" step="0.01">
                            </div>
                        </td>
                    </tr>
                    <tr class="table-primary fw-bold">
                        <td>Grand Total</td>
                        <td class="text-end fs-5">Rs. <span id="grand-total">0.00</span></td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Payment & Submit -->
        <div class="card">
            <div class="card-header"><i class="bi bi-credit-card me-1"></i>Payment</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Payment Mode</label>
                    <select class="form-select" id="payment-mode">
                        {% for value, label in payment_modes %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary btn-lg" id="submit-invoice">
                        <i class="bi bi-check-circle me-2"></i>Create Invoice
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Search Modal -->
<div class="modal fade" id="productSearchModal" tabindex="-1" aria-labelledby="productSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productSearchModalLabel"><i class="bi bi-search me-2"></i>Search Products</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="search-input-container">
                    <input type="text" class="form-control form-control-lg" id="modal-product-search"
                           placeholder="Type product name, barcode or HSN code..." autocomplete="off" autofocus>
                </div>
                <div class="product-list" id="modal-search-results">
                    <div class="no-results">
                        <i class="bi bi-search" style="font-size: 3rem;"></i>
                        <p class="mt-2">Start typing to search products...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Product Search Modal functionality
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('productSearchModal');
    const searchInput = document.getElementById('modal-product-search');
    const resultsContainer = document.getElementById('modal-search-results');
    let searchTimeout = null;

    // Focus search input when modal opens
    modal.addEventListener('shown.bs.modal', function() {
        searchInput.value = '';
        searchInput.focus();
        resultsContainer.innerHTML = '<div class="no-results"><i class="bi bi-search" style="font-size: 3rem;"></i><p class="mt-2">Start typing to search products...</p></div>';
    });

    // F2 shortcut to open modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F2') {
            e.preventDefault();
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
        }
    });

    // Search products
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();

        if (searchTimeout) clearTimeout(searchTimeout);

        if (query.length < 2) {
            resultsContainer.innerHTML = '<div class="no-results"><i class="bi bi-search" style="font-size: 3rem;"></i><p class="mt-2">Type at least 2 characters...</p></div>';
            return;
        }

        resultsContainer.innerHTML = '<div class="no-results"><div class="spinner-border spinner-border-sm" role="status"></div> Searching...</div>';

        searchTimeout = setTimeout(() => {
            fetch(`/products/api/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(products => {
                    if (products.length === 0) {
                        resultsContainer.innerHTML = '<div class="no-results"><i class="bi bi-inbox" style="font-size: 3rem;"></i><p class="mt-2">No products found</p></div>';
                        return;
                    }

                    resultsContainer.innerHTML = products.map(p => {
                        let stockClass = 'stock-ok';
                        let stockText = `In Stock: ${p.stock_qty}`;
                        if (p.stock_qty <= 0) {
                            stockClass = 'stock-out';
                            stockText = 'Out of Stock';
                        } else if (p.stock_qty <= (p.low_stock_alert || 10)) {
                            stockClass = 'stock-low';
                            stockText = `Low Stock: ${p.stock_qty}`;
                        }

                        return `
                            <div class="product-item" onclick="addProductToCart(${JSON.stringify(p).replace(/"/g, '&quot;')})">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="product-name">${escapeHtml(p.name)}</div>
                                        <div class="product-details">
                                            HSN: ${p.hsn_code || '-'} | Unit: ${p.unit} | GST: ${p.gst_rate}%
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="product-price">Rs. ${parseFloat(p.price).toFixed(2)}</div>
                                        <div class="product-stock ${stockClass}">${stockText}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                })
                .catch(err => {
                    resultsContainer.innerHTML = '<div class="no-results text-danger"><i class="bi bi-exclamation-circle" style="font-size: 2rem;"></i><p class="mt-2">Error searching products</p></div>';
                });
        }, 300);
    });

    // Keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            bootstrap.Modal.getInstance(modal).hide();
        }
    });
});

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function addProductToCart(product) {
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('productSearchModal')).hide();
    // Add to cart using the existing cart object
    if (typeof cart !== 'undefined') {
        cart.addItem(product);
    }
}

// Customer search dropdown
document.addEventListener('DOMContentLoaded', function() {
    const customerSearch = document.getElementById('customer-search');
    const customerResults = document.getElementById('customer-results');
    let customerTimeout = null;

    customerSearch.addEventListener('input', function() {
        const query = this.value.trim();
        if (customerTimeout) clearTimeout(customerTimeout);

        if (query.length < 2) {
            customerResults.style.display = 'none';
            return;
        }

        customerTimeout = setTimeout(() => {
            fetch(`/customers/api/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(customers => {
                    if (customers.length === 0) {
                        customerResults.style.display = 'none';
                        return;
                    }

                    customerResults.innerHTML = customers.map(c => `
                        <div class="customer-item" onclick="selectCustomer(${JSON.stringify(c).replace(/"/g, '&quot;')})">
                            <strong>${escapeHtml(c.name)}</strong>
                            <div style="font-size: 0.85rem; color: #666;">
                                ${c.phone || ''} ${c.gstin ? '| GSTIN: ' + c.gstin : ''}
                            </div>
                        </div>
                    `).join('');
                    customerResults.style.display = 'block';
                })
                .catch(() => {
                    customerResults.style.display = 'none';
                });
        }, 300);
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!customerSearch.contains(e.target) && !customerResults.contains(e.target)) {
            customerResults.style.display = 'none';
        }
    });
});

function selectCustomer(customer) {
    document.getElementById('customer-search').value = customer.name;
    document.getElementById('customer-results').style.display = 'none';

    if (typeof cart !== 'undefined') {
        cart.setCustomer(customer);
    }

    // Show customer info
    const infoDiv = document.getElementById('selected-customer-info');
    infoDiv.innerHTML = `
        <div class="alert alert-success py-2 mb-0">
            <strong>${escapeHtml(customer.name)}</strong>
            ${customer.gstin ? '<br><small>GSTIN: ' + customer.gstin + '</small>' : ''}
            ${customer.phone ? '<br><small>Phone: ' + customer.phone + '</small>' : ''}
            <button type="button" class="btn-close btn-sm float-end" onclick="clearCustomer()"></button>
        </div>
    `;
}

function clearCustomer() {
    document.getElementById('customer-search').value = '';
    document.getElementById('selected-customer-info').innerHTML = '';
    if (typeof cart !== 'undefined') {
        cart.setCustomer(null);
    }
}
</script>
<script src="{{ url_for('static', filename='js/billing.js') }}"></script>
{% endblock %}
