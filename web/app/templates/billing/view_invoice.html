{% extends 'base.html' %}

{% block title %}{{ invoice.invoice_number }} - Cosmic Surgical{% endblock %}

{% block content %}
<!-- Action Buttons - Only visible on screen -->
<div class="d-flex justify-content-between align-items-center mb-4 no-print">
    <h2>
        <i class="bi bi-receipt me-2"></i>Invoice View
    </h2>
    <div>
        {% if not invoice.is_cancelled %}
        <a href="{{ url_for('billing.download_invoice_pdf', id=invoice.id) }}" class="btn btn-primary me-2">
            <i class="bi bi-file-pdf me-1"></i>Download PDF
        </a>
        {% if invoice.customer_phone %}
        <button type="button" class="btn btn-success me-2" onclick="shareWhatsApp()">
            <i class="bi bi-whatsapp me-1"></i>WhatsApp
        </button>
        {% else %}
        <button type="button" class="btn btn-outline-success me-2" data-bs-toggle="modal" data-bs-target="#whatsappModal">
            <i class="bi bi-whatsapp me-1"></i>WhatsApp
        </button>
        {% endif %}
        <button type="button" class="btn btn-outline-primary me-2" onclick="window.print()">
            <i class="bi bi-printer me-1"></i>Print
        </button>
        <form action="{{ url_for('billing.cancel_invoice', id=invoice.id) }}" method="POST" class="d-inline"
              onsubmit="return confirm('Cancel this invoice? This action cannot be undone.')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-outline-danger me-2">
                <i class="bi bi-x-circle me-1"></i>Cancel
            </button>
        </form>
        {% endif %}
        <a href="{{ url_for('billing.invoice_list') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Back
        </a>
    </div>
</div>

<!-- Professional Invoice Layout -->
<div class="invoice-container">
    <div class="invoice-paper">
        <!-- Cancelled Watermark -->
        {% if invoice.is_cancelled %}
        <div class="invoice-cancelled-watermark">CANCELLED</div>
        {% endif %}

        <!-- Invoice Header -->
        <div class="invoice-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    {% if company %}
                    <h2 class="company-name mb-1">{{ company.name }}</h2>
                    <p class="company-details mb-0">
                        {{ company.address }}<br>
                        {% if company.phone %}Phone: {{ company.phone }}{% endif %}
                        {% if company.email %} | {{ company.email }}{% endif %}
                        {% if company.gstin %}<br><strong>GSTIN: {{ company.gstin }}</strong>{% endif %}
                    </p>
                    {% else %}
                    <h2 class="company-name mb-1">Your Company Name</h2>
                    <p class="company-details mb-0 text-muted">Company details not configured</p>
                    {% endif %}
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="invoice-info-box">
                        <div class="invoice-title">TAX INVOICE</div>
                        <table class="invoice-meta-table">
                            <tr>
                                <td>Invoice No:</td>
                                <td><strong>{{ invoice.invoice_number }}</strong></td>
                            </tr>
                            <tr>
                                <td>Date:</td>
                                <td>{{ invoice.invoice_date.strftime('%d-%m-%Y') if invoice.invoice_date else '-' }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bill To / Ship To Section -->
        <div class="invoice-parties">
            <div class="row">
                <div class="col-md-6">
                    <div class="party-box bill-from">
                        <div class="party-label">Bill From</div>
                        {% if company %}
                        <strong>{{ company.name }}</strong><br>
                        {{ company.address }}<br>
                        {% if company.gstin %}GSTIN: {{ company.gstin }}<br>{% endif %}
                        {% if company.state_name %}State: {{ company.state_name }}{% endif %}
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="party-box bill-to">
                        <div class="party-label">Bill To</div>
                        <strong>{{ invoice.customer_name or 'Walk-in Customer' }}</strong>
                        {% if invoice.customer %}
                        <br>{{ invoice.customer.address or '' }}
                        {% if invoice.customer.gstin %}<br>GSTIN: {{ invoice.customer.gstin }}{% endif %}
                        {% if invoice.customer.phone %}<br>Phone: {{ invoice.customer.phone }}{% endif %}
                        {% if invoice.customer.state_name %}<br>State: {{ invoice.customer.state_name }}{% endif %}
                        {% elif invoice.customer_phone %}
                        <br><i class="bi bi-whatsapp text-success"></i> {{ invoice.customer_phone }}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Items Table -->
        <div class="invoice-items">
            <table class="items-table">
                <thead>
                    <tr>
                        <th class="text-center" style="width: 40px;">#</th>
                        <th>Description</th>
                        <th class="text-center" style="width: 70px;">Batch#</th>
                        <th class="text-center" style="width: 70px;">HSN</th>
                        <th class="text-center" style="width: 70px;">Qty</th>
                        <th class="text-end" style="width: 80px;">Rate</th>
                        <th class="text-end" style="width: 90px;">Taxable</th>
                        <th class="text-center" style="width: 50px;">GST%</th>
                        <th class="text-end" style="width: 70px;">Tax</th>
                        <th class="text-end" style="width: 90px;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr class="{{ 'row-alt' if loop.index is odd else '' }}">
                        <td class="text-center">{{ loop.index }}</td>
                        <td>{{ item.product_name }}</td>
                        <td class="text-center">{{ item.batch_number or '-' }}</td>
                        <td class="text-center">{{ item.hsn_code or '-' }}</td>
                        <td class="text-center">{{ "%.2f"|format(item.qty) }} {{ item.unit }}</td>
                        <td class="text-end">{{ "%.2f"|format(item.rate) }}</td>
                        <td class="text-end">{{ "%.2f"|format(item.taxable_value) }}</td>
                        <td class="text-center">{{ "%.0f"|format(item.gst_rate) }}%</td>
                        <td class="text-end">{{ "%.2f"|format(item.cgst + item.sgst + item.igst) }}</td>
                        <td class="text-end"><strong>{{ "%.2f"|format(item.total) }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Totals and Tax Summary Row -->
        <div class="invoice-summary">
            <div class="row">
                <!-- Tax Summary -->
                <div class="col-md-7">
                    {% if tax_summary %}
                    <div class="tax-summary-box">
                        <div class="tax-summary-title">Tax Summary (HSN-wise)</div>
                        <table class="tax-summary-table">
                            <thead>
                                <tr>
                                    <th>GST Rate</th>
                                    <th class="text-end">Taxable</th>
                                    <th class="text-end">CGST</th>
                                    <th class="text-end">SGST</th>
                                    <th class="text-end">IGST</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in tax_summary %}
                                <tr>
                                    <td>{{ row.gst_rate }}%</td>
                                    <td class="text-end">{{ "%.2f"|format(row.taxable_value) }}</td>
                                    <td class="text-end">{{ "%.2f"|format(row.cgst) }}</td>
                                    <td class="text-end">{{ "%.2f"|format(row.sgst) }}</td>
                                    <td class="text-end">{{ "%.2f"|format(row.igst) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                    <!-- Bank Details -->
                    {% if company and company.bank_name %}
                    <div class="bank-details-box mt-3">
                        <div class="bank-details-title"><i class="bi bi-bank me-1"></i>Bank Details</div>
                        <table class="bank-details-table">
                            <tr>
                                <td>Bank Name:</td>
                                <td>{{ company.bank_name }}</td>
                            </tr>
                            <tr>
                                <td>Account No:</td>
                                <td>{{ company.account_number }}</td>
                            </tr>
                            <tr>
                                <td>IFSC Code:</td>
                                <td>{{ company.ifsc_code }}</td>
                            </tr>
                            {% if company.upi_id %}
                            <tr>
                                <td>UPI ID:</td>
                                <td>{{ company.upi_id }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                    {% endif %}
                </div>

                <!-- Totals Box -->
                <div class="col-md-5">
                    <div class="totals-box">
                        <table class="totals-table">
                            <tr>
                                <td>Subtotal</td>
                                <td class="text-end">Rs. {{ "%.2f"|format(invoice.subtotal) }}</td>
                            </tr>
                            {% if tax_summary %}
                            {% for row in tax_summary %}
                            {% if row.cgst > 0 %}
                            <tr>
                                <td>CGST ({{ "%.1f"|format(row.gst_rate / 2) }}%)</td>
                                <td class="text-end">Rs. {{ "%.2f"|format(row.cgst) }}</td>
                            </tr>
                            <tr>
                                <td>SGST ({{ "%.1f"|format(row.gst_rate / 2) }}%)</td>
                                <td class="text-end">Rs. {{ "%.2f"|format(row.sgst) }}</td>
                            </tr>
                            {% endif %}
                            {% if row.igst > 0 %}
                            <tr>
                                <td>IGST ({{ "%.1f"|format(row.gst_rate) }}%)</td>
                                <td class="text-end">Rs. {{ "%.2f"|format(row.igst) }}</td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                            {% if invoice.discount > 0 %}
                            <tr class="discount-row">
                                <td>Discount</td>
                                <td class="text-end text-danger">- Rs. {{ "%.2f"|format(invoice.discount) }}</td>
                            </tr>
                            {% endif %}
                            <tr class="grand-total-row">
                                <td><strong>GRAND TOTAL</strong></td>
                                <td class="text-end"><strong>Rs. {{ "%.2f"|format(invoice.grand_total) }}</strong></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Payment Status -->
                    <div class="payment-status-box mt-3">
                        <table class="payment-status-table">
                            <tr>
                                <td>Payment Mode:</td>
                                <td><span class="badge bg-info">{{ invoice.payment_mode }}</span></td>
                            </tr>
                            <tr>
                                <td>Status:</td>
                                <td>
                                    {% if invoice.payment_status == 'PAID' %}
                                    <span class="badge bg-success">PAID</span>
                                    {% elif invoice.payment_status == 'PARTIAL' %}
                                    <span class="badge bg-warning">PARTIAL</span>
                                    {% else %}
                                    <span class="badge bg-danger">UNPAID</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if invoice.balance_due > 0 %}
                            <tr>
                                <td>Balance Due:</td>
                                <td class="text-danger"><strong>Rs. {{ "%.2f"|format(invoice.balance_due) }}</strong></td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- E-Way Bill Section (only show if invoice >= Rs.50,000) -->
        {% if invoice.grand_total >= 50000 and not invoice.is_cancelled %}
        <div class="eway-bill-section mt-4 no-print">
            <div class="eway-bill-box">
                <div class="eway-bill-header">
                    <i class="bi bi-truck me-2"></i>E-Way Bill
                    <span class="badge bg-warning ms-2">Required (Invoice > Rs.50,000)</span>
                </div>
                <div class="eway-bill-body">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- E-Way Bill Number -->
                            {% if invoice.eway_bill_number %}
                            <div class="eway-number-display">
                                <label class="eway-label">E-Way Bill Number</label>
                                <div class="eway-number">{{ invoice.eway_bill_number }}</div>
                            </div>
                            {% else %}
                            <div class="eway-number-input">
                                <label class="form-label">Enter E-Way Bill Number</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="eway-bill-input"
                                           placeholder="12-digit e-Way bill number" maxlength="12">
                                    <button class="btn btn-success" type="button" onclick="saveEwayBillNumber()">
                                        <i class="bi bi-check-circle"></i> Save
                                    </button>
                                </div>
                                <small class="text-muted">Enter after generating on GST portal</small>
                            </div>
                            {% endif %}

                            <!-- Transport Details -->
                            {% if invoice.transport_distance or invoice.vehicle_number %}
                            <div class="transport-details mt-3">
                                <label class="eway-label">Transport Details</label>
                                <table class="transport-table">
                                    <tr>
                                        <td>Mode:</td>
                                        <td>{{ invoice.transport_mode or 'Road' }}</td>
                                    </tr>
                                    {% if invoice.vehicle_number %}
                                    <tr>
                                        <td>Vehicle:</td>
                                        <td>{{ invoice.vehicle_number }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if invoice.transport_distance %}
                                    <tr>
                                        <td>Distance:</td>
                                        <td>{{ invoice.transport_distance }} km</td>
                                    </tr>
                                    {% endif %}
                                    {% if invoice.transporter_id %}
                                    <tr>
                                        <td>Transporter ID:</td>
                                        <td>{{ invoice.transporter_id }}</td>
                                    </tr>
                                    {% endif %}
                                </table>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <!-- Step-by-Step Instructions -->
                            {% if not invoice.eway_bill_number %}
                            <div class="eway-instructions mb-3">
                                <label class="eway-label">How to Generate E-Way Bill</label>
                                <ol class="eway-steps">
                                    <li><strong>Step 1:</strong> Click "Download JSON" below to get the data file</li>
                                    <li><strong>Step 2:</strong> Go to <a href="https://ewaybillgst.gov.in" target="_blank">GST E-Way Bill Portal</a> and login</li>
                                    <li><strong>Step 3:</strong> Navigate to "Generate New" > "E-Way Bill"</li>
                                    <li><strong>Step 4:</strong> Upload the JSON file or enter details manually</li>
                                    <li><strong>Step 5:</strong> Copy the 12-digit E-Way Bill number generated</li>
                                    <li><strong>Step 6:</strong> Enter the number in the field on the left and save</li>
                                </ol>
                            </div>
                            {% endif %}

                            <!-- E-Way Bill Actions -->
                            <div class="eway-actions">
                                <label class="eway-label">Actions</label>
                                <div class="d-grid gap-2">
                                    <a href="{{ url_for('billing.export_eway_bill_json', id=invoice.id) }}"
                                       class="btn btn-outline-primary" download>
                                        <i class="bi bi-file-earmark-code me-1"></i>Download JSON for Portal
                                    </a>
                                    <a href="https://ewaybillgst.gov.in" target="_blank"
                                       class="btn btn-outline-secondary">
                                        <i class="bi bi-box-arrow-up-right me-1"></i>Open GST E-Way Bill Portal
                                    </a>
                                </div>
                            </div>

                            <!-- Validity Info -->
                            {% if invoice.transport_distance %}
                            {% set validity_days = ((invoice.transport_distance + 99) // 100) or 1 %}
                            <div class="validity-info mt-3">
                                <label class="eway-label">Validity</label>
                                <div class="validity-badge">
                                    <i class="bi bi-clock me-1"></i>{{ validity_days }} day(s) from generation
                                </div>
                                <small class="text-muted">Based on {{ invoice.transport_distance }} km distance</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Invoice Footer -->
        <div class="invoice-footer">
            <div class="row">
                <div class="col-md-6">
                    <div class="terms-box">
                        <strong>Terms & Conditions:</strong>
                        <ol class="terms-list">
                            <li>Goods once sold will not be taken back.</li>
                            <li>Interest @18% p.a. will be charged on delayed payments.</li>
                            <li>Subject to local jurisdiction only.</li>
                        </ol>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="signature-box">
                        <p class="mb-4">For {{ company.name if company else 'Company Name' }}</p>
                        <div class="signature-line"></div>
                        <p class="signature-label">Authorized Signatory</p>
                    </div>
                </div>
            </div>
            <div class="thank-you-message">
                Thank you for your business!
            </div>
        </div>
    </div>
</div>

<style>
/* Professional Invoice Styles */
.invoice-container {
    max-width: 900px;
    margin: 0 auto;
}

.invoice-paper {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: relative;
}

.invoice-cancelled-watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-45deg);
    font-size: 80px;
    font-weight: bold;
    color: rgba(220, 53, 69, 0.15);
    pointer-events: none;
    z-index: 1;
}

/* Header */
.invoice-header {
    border-bottom: 3px solid #1a5276;
    padding-bottom: 20px;
    margin-bottom: 20px;
}

.company-name {
    color: #1a5276;
    font-weight: 700;
    font-size: 1.8rem;
}

.company-details {
    color: #666;
    font-size: 0.9rem;
}

.invoice-info-box {
    background: #f8f9fa;
    border: 2px solid #1a5276;
    border-radius: 8px;
    padding: 15px;
    display: inline-block;
}

.invoice-title {
    background: #1a5276;
    color: white;
    font-size: 1.2rem;
    font-weight: 700;
    text-align: center;
    padding: 8px 20px;
    margin: -15px -15px 15px -15px;
    border-radius: 6px 6px 0 0;
}

.invoice-meta-table {
    width: 100%;
}

.invoice-meta-table td {
    padding: 3px 0;
}

.invoice-meta-table td:first-child {
    color: #666;
    padding-right: 15px;
}

/* Parties Section */
.invoice-parties {
    margin-bottom: 25px;
}

.party-box {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
    min-height: 120px;
    font-size: 0.9rem;
}

.party-label {
    background: #2980b9;
    color: white;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    padding: 4px 10px;
    border-radius: 4px;
    display: inline-block;
    margin-bottom: 10px;
}

.bill-from {
    background: #f8f9fa;
}

/* Items Table */
.invoice-items {
    margin-bottom: 25px;
}

.items-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.items-table thead th {
    background: #1a5276;
    color: white;
    padding: 10px 8px;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.3px;
}

.items-table thead th:first-child {
    border-radius: 6px 0 0 0;
}

.items-table thead th:last-child {
    border-radius: 0 6px 0 0;
}

.items-table tbody td {
    padding: 10px 8px;
    border-bottom: 1px solid #e9ecef;
}

.items-table tbody tr.row-alt {
    background: #f8f9fa;
}

.items-table tbody tr:hover {
    background: #e8f4f8;
}

/* Tax Summary */
.tax-summary-box {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    overflow: hidden;
}

.tax-summary-title {
    background: #2980b9;
    color: white;
    font-size: 0.8rem;
    font-weight: 600;
    padding: 8px 12px;
}

.tax-summary-table {
    width: 100%;
    font-size: 0.8rem;
}

.tax-summary-table th {
    background: #f8f9fa;
    padding: 8px;
    font-weight: 600;
    font-size: 0.7rem;
    text-transform: uppercase;
}

.tax-summary-table td {
    padding: 6px 8px;
    border-bottom: 1px solid #e9ecef;
}

/* Bank Details */
.bank-details-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 12px;
}

.bank-details-title {
    font-weight: 600;
    color: #1a5276;
    margin-bottom: 8px;
    font-size: 0.85rem;
}

.bank-details-table {
    font-size: 0.8rem;
}

.bank-details-table td {
    padding: 2px 0;
}

.bank-details-table td:first-child {
    color: #666;
    width: 100px;
}

/* Totals Box */
.totals-box {
    border: 2px solid #1a5276;
    border-radius: 8px;
    overflow: hidden;
}

.totals-table {
    width: 100%;
}

.totals-table td {
    padding: 10px 15px;
    border-bottom: 1px solid #e9ecef;
}

.totals-table td:first-child {
    color: #666;
}

.grand-total-row {
    background: #1a5276;
    color: white;
}

.grand-total-row td {
    border-bottom: none;
    color: white;
    font-size: 1.1rem;
}

/* Payment Status */
.payment-status-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 12px;
}

.payment-status-table {
    width: 100%;
    font-size: 0.85rem;
}

.payment-status-table td {
    padding: 4px 0;
}

.payment-status-table td:first-child {
    color: #666;
}

/* Footer */
.invoice-footer {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #dee2e6;
}

.terms-box {
    font-size: 0.75rem;
    color: #666;
}

.terms-list {
    margin: 5px 0 0 0;
    padding-left: 15px;
}

.terms-list li {
    margin-bottom: 2px;
}

.signature-box {
    margin-top: 20px;
}

.signature-line {
    border-bottom: 1px solid #333;
    width: 180px;
    margin-left: auto;
    margin-bottom: 5px;
}

.signature-label {
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 0;
}

.thank-you-message {
    text-align: center;
    margin-top: 25px;
    padding-top: 15px;
    border-top: 1px dashed #dee2e6;
    color: #1a5276;
    font-weight: 600;
    font-size: 1rem;
}

/* E-Way Bill Section */
.eway-bill-section {
    margin-top: 25px;
}

.eway-bill-box {
    border: 2px solid #ffc107;
    border-radius: 8px;
    overflow: hidden;
}

.eway-bill-header {
    background: #ffc107;
    color: #212529;
    font-weight: 600;
    padding: 12px 15px;
}

.eway-bill-body {
    padding: 20px;
    background: #fffbeb;
}

.eway-label {
    font-weight: 600;
    color: #666;
    font-size: 0.85rem;
    display: block;
    margin-bottom: 5px;
}

.eway-number-display .eway-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #28a745;
    font-family: monospace;
}

.transport-table {
    font-size: 0.9rem;
    width: 100%;
}

.transport-table td {
    padding: 4px 0;
}

.transport-table td:first-child {
    color: #666;
    width: 100px;
}

.eway-instructions {
    background: #fff3cd;
    padding: 12px;
    border-radius: 6px;
    border-left: 4px solid #ffc107;
}

.eway-steps {
    margin: 0;
    padding-left: 20px;
    font-size: 0.85rem;
}

.eway-steps li {
    margin-bottom: 6px;
    line-height: 1.4;
}

.eway-steps li:last-child {
    margin-bottom: 0;
}

.eway-steps a {
    color: #0d6efd;
}

.validity-badge {
    background: #17a2b8;
    color: white;
    padding: 8px 15px;
    border-radius: 6px;
    display: inline-block;
    font-weight: 600;
}

/* Print Styles */
@media print {
    .no-print {
        display: none !important;
    }

    body {
        background: white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    .invoice-container {
        max-width: 100%;
        margin: 0;
    }

    .invoice-paper {
        border: none;
        box-shadow: none;
        padding: 0;
    }

    .items-table thead th {
        background: #1a5276 !important;
        color: white !important;
        -webkit-print-color-adjust: exact !important;
    }

    .grand-total-row {
        background: #1a5276 !important;
        color: white !important;
        -webkit-print-color-adjust: exact !important;
    }

    .tax-summary-title {
        background: #2980b9 !important;
        color: white !important;
        -webkit-print-color-adjust: exact !important;
    }

    .party-label {
        background: #2980b9 !important;
        color: white !important;
        -webkit-print-color-adjust: exact !important;
    }

    .row-alt {
        background: #f8f9fa !important;
        -webkit-print-color-adjust: exact !important;
    }
}
</style>

<script>
function saveEwayBillNumber() {
    const input = document.getElementById('eway-bill-input');
    const ewayNumber = input.value.trim();

    if (!ewayNumber) {
        alert('Please enter the e-Way bill number');
        return;
    }

    if (!/^\d{12}$/.test(ewayNumber)) {
        alert('E-Way bill number must be exactly 12 digits');
        return;
    }

    fetch('{{ url_for("billing.save_eway_bill_number", id=invoice.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ eway_bill_number: ewayNumber })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to save'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving e-Way bill number');
    });
}

// WhatsApp Sharing with PDF
async function shareWhatsApp() {
    const invoiceNumber = '{{ invoice.invoice_number }}';
    const invoiceId = {{ invoice.id }};
    const companyName = '{{ company.name if company else "Our Store" }}';
    const amount = {{ invoice.grand_total }};
    const invoiceDate = '{{ invoice.invoice_date.strftime("%d-%b-%Y") if invoice.invoice_date else "" }}';
    const phone = '{{ invoice.customer_phone or "" }}';
    const formattedAmount = parseFloat(amount).toLocaleString('en-IN', {minimumFractionDigits: 2});

    // Check if Web Share API with files is supported (mobile)
    if (navigator.canShare) {
        try {
            const testFile = new File(['test'], 'test.pdf', { type: 'application/pdf' });
            if (navigator.canShare({ files: [testFile] })) {
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Loading...';
                btn.disabled = true;

                const response = await fetch(`/billing/invoices/${invoiceId}/pdf`);
                const blob = await response.blob();
                const file = new File([blob], `Invoice-${invoiceNumber.replace(/\//g, '-')}.pdf`, { type: 'application/pdf' });

                await navigator.share({
                    title: `Invoice ${invoiceNumber}`,
                    text: `Invoice from ${companyName}\nInvoice No: ${invoiceNumber}\nDate: ${invoiceDate}\nAmount: Rs. ${formattedAmount}`,
                    files: [file]
                });

                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }
        } catch (error) {
            console.log('Web Share failed, using fallback:', error);
        }
    }

    // Fallback: Download PDF + Open WhatsApp
    downloadAndOpenWhatsApp(phone, invoiceNumber, invoiceDate, formattedAmount, invoiceId, companyName);
}

function downloadAndOpenWhatsApp(phone, invoiceNumber, invoiceDate, formattedAmount, invoiceId, companyName) {
    // Step 1: Download the PDF
    const pdfUrl = `/billing/invoices/${invoiceId}/pdf`;
    const link = document.createElement('a');
    link.href = pdfUrl;
    link.download = `Invoice-${invoiceNumber.replace(/\//g, '-')}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Step 2: Open WhatsApp with message
    const message = `Invoice from ${companyName}

Invoice No: ${invoiceNumber}
Date: ${invoiceDate}
Amount: Rs. ${formattedAmount}

Please find the invoice PDF attached.

Thank you for your purchase!`;

    let whatsappUrl;
    const cleanPhone = (phone || '').replace(/\D/g, '');
    if (cleanPhone.length === 10) {
        whatsappUrl = `https://wa.me/91${cleanPhone}?text=${encodeURIComponent(message)}`;
    } else if (cleanPhone.length > 0) {
        whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
    } else {
        whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    }

    // Small delay to ensure download starts first
    setTimeout(() => {
        window.open(whatsappUrl, '_blank');
        alert('PDF downloaded! Please attach it in WhatsApp.');
    }, 500);
}

async function shareWhatsAppWithNumber() {
    const phone = document.getElementById('wa-phone-input').value.trim();
    if (!phone || phone.length !== 10) {
        alert('Please enter a valid 10-digit WhatsApp number');
        return;
    }

    const invoiceNumber = '{{ invoice.invoice_number }}';
    const invoiceId = {{ invoice.id }};
    const companyName = '{{ company.name if company else "Our Store" }}';
    const amount = {{ invoice.grand_total }};
    const invoiceDate = '{{ invoice.invoice_date.strftime("%d-%b-%Y") if invoice.invoice_date else "" }}';
    const formattedAmount = parseFloat(amount).toLocaleString('en-IN', {minimumFractionDigits: 2});

    // Check if Web Share API with files is supported (mobile)
    if (navigator.canShare) {
        try {
            const testFile = new File(['test'], 'test.pdf', { type: 'application/pdf' });
            if (navigator.canShare({ files: [testFile] })) {
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Loading...';
                btn.disabled = true;

                const response = await fetch(`/billing/invoices/${invoiceId}/pdf`);
                const blob = await response.blob();
                const file = new File([blob], `Invoice-${invoiceNumber.replace(/\//g, '-')}.pdf`, { type: 'application/pdf' });

                await navigator.share({
                    title: `Invoice ${invoiceNumber}`,
                    text: `Invoice from ${companyName}\nAmount: Rs. ${formattedAmount}`,
                    files: [file]
                });

                btn.innerHTML = originalText;
                btn.disabled = false;
                bootstrap.Modal.getInstance(document.getElementById('whatsappModal')).hide();
                return;
            }
        } catch (error) {
            console.log('Web Share failed, using fallback:', error);
        }
    }

    // Fallback
    bootstrap.Modal.getInstance(document.getElementById('whatsappModal')).hide();
    downloadAndOpenWhatsApp(phone, invoiceNumber, invoiceDate, formattedAmount, invoiceId, companyName);
}
</script>

<!-- WhatsApp Modal -->
<div class="modal fade" id="whatsappModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white py-2">
                <h6 class="modal-title"><i class="bi bi-whatsapp me-2"></i>Share on WhatsApp</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">WhatsApp Number</label>
                    <div class="input-group">
                        <span class="input-group-text">+91</span>
                        <input type="tel" class="form-control" id="wa-phone-input" placeholder="9876543210" maxlength="10">
                    </div>
                </div>
                <button type="button" class="btn btn-success w-100" onclick="shareWhatsAppWithNumber()">
                    <i class="bi bi-send me-2"></i>Share Invoice
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
