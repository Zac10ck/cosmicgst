{% extends 'base.html' %}

{% block title %}GSTR-3B Report - GST Billing{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-file-earmark-text me-2"></i>GSTR-3B Summary</h2>
    <div>
        <a href="{{ url_for('reports.export_gstr3b', month=month, year=year) }}" class="btn btn-success me-2">
            <i class="bi bi-file-earmark-excel me-1"></i>Export Excel
        </a>
        <a href="{{ url_for('reports.index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Back
        </a>
    </div>
</div>

<!-- Period Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Month</label>
                <select class="form-select" name="month">
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m == month %}selected{% endif %}>
                        {{ ['January', 'February', 'March', 'April', 'May', 'June',
                            'July', 'August', 'September', 'October', 'November', 'December'][m-1] }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Year</label>
                <select class="form-select" name="year">
                    {% for y in range(2020, 2031) %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-filter me-1"></i>Generate Report
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Period Info -->
<div class="alert alert-info mb-4">
    <i class="bi bi-calendar3 me-2"></i>
    <strong>Return Period:</strong> {{ ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'][month-1] }} {{ year }}
    ({{ start_date.strftime('%d/%m/%Y') }} to {{ end_date.strftime('%d/%m/%Y') }})
    <span class="ms-3 badge bg-primary">{{ invoice_count }} Invoices</span>
    <span class="ms-1 badge bg-warning text-dark">{{ cn_count }} Credit Notes</span>
</div>

<!-- Section 3.1 - Outward Supplies -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <i class="bi bi-box-arrow-right me-1"></i>
        <strong>3.1 Details of Outward Supplies and Inward Supplies liable to Reverse Charge</strong>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40%;">Nature of Supplies</th>
                        <th class="text-end">Taxable Value (Rs.)</th>
                        <th class="text-end">IGST (Rs.)</th>
                        <th class="text-end">CGST (Rs.)</th>
                        <th class="text-end">SGST (Rs.)</th>
                        <th class="text-end">Cess (Rs.)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <strong>(a)</strong> Outward taxable supplies (other than zero rated, nil rated and exempted)
                        </td>
                        <td class="text-end">{{ "%.2f"|format(taxable_outward.taxable_value) }}</td>
                        <td class="text-end">{{ "%.2f"|format(taxable_outward.igst) }}</td>
                        <td class="text-end">{{ "%.2f"|format(taxable_outward.cgst) }}</td>
                        <td class="text-end">{{ "%.2f"|format(taxable_outward.sgst) }}</td>
                        <td class="text-end">{{ "%.2f"|format(taxable_outward.cess) }}</td>
                    </tr>
                    <tr>
                        <td>
                            <strong>(b)</strong> Outward taxable supplies (zero rated)
                        </td>
                        <td class="text-end">{{ "%.2f"|format(zero_rated.taxable_value) }}</td>
                        <td class="text-end">{{ "%.2f"|format(zero_rated.igst) }}</td>
                        <td class="text-end">-</td>
                        <td class="text-end">-</td>
                        <td class="text-end">-</td>
                    </tr>
                    <tr>
                        <td>
                            <strong>(c)</strong> Other outward supplies (nil rated, exempted)
                        </td>
                        <td class="text-end">{{ "%.2f"|format(exempt_nil.taxable_value) }}</td>
                        <td class="text-end text-muted">Nil</td>
                        <td class="text-end text-muted">Nil</td>
                        <td class="text-end text-muted">Nil</td>
                        <td class="text-end text-muted">Nil</td>
                    </tr>
                    <tr class="table-warning">
                        <td>
                            <strong>(d)</strong> Inward supplies (liable to reverse charge)
                        </td>
                        <td class="text-end">{{ "%.2f"|format(reverse_charge.taxable_value) }}</td>
                        <td class="text-end">{{ "%.2f"|format(reverse_charge.igst) }}</td>
                        <td class="text-end">{{ "%.2f"|format(reverse_charge.cgst) }}</td>
                        <td class="text-end">{{ "%.2f"|format(reverse_charge.sgst) }}</td>
                        <td class="text-end">{{ "%.2f"|format(reverse_charge.cess) }}</td>
                    </tr>
                    <tr>
                        <td>
                            <strong>(e)</strong> Non-GST outward supplies
                        </td>
                        <td class="text-end">0.00</td>
                        <td class="text-end text-muted">-</td>
                        <td class="text-end text-muted">-</td>
                        <td class="text-end text-muted">-</td>
                        <td class="text-end text-muted">-</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Section 3.2 - Inter-state supplies -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <i class="bi bi-truck me-1"></i>
        <strong>3.2 Inter-State Supplies made to Unregistered Persons, Composition Dealers and UIN holders</strong>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 60%;">Place of Supply (State/UT)</th>
                        <th class="text-end">Taxable Value (Rs.)</th>
                        <th class="text-end">IGST (Rs.)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <strong>(a)</strong> Supplies made to Unregistered Persons (B2C)
                        </td>
                        <td class="text-end">{{ "%.2f"|format(b2c_interstate.taxable_value) }}</td>
                        <td class="text-end">-</td>
                    </tr>
                    <tr>
                        <td>
                            <strong>(b)</strong> Supplies made to Composition Taxable Persons
                        </td>
                        <td class="text-end">0.00</td>
                        <td class="text-end">-</td>
                    </tr>
                    <tr>
                        <td>
                            <strong>(c)</strong> Supplies made to UIN holders
                        </td>
                        <td class="text-end">0.00</td>
                        <td class="text-end">-</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Credit Notes Adjustment -->
{% if cn_count > 0 %}
<div class="card mb-4">
    <div class="card-header bg-warning">
        <i class="bi bi-dash-circle me-1"></i>
        <strong>Credit Notes Issued (Deduction from Liability)</strong>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="text-muted small">Total Credit Notes</div>
                <div class="h5">Rs. {{ "%.2f"|format(cn_total) }}</div>
            </div>
            <div class="col-md-3">
                <div class="text-muted small">CGST Reversal</div>
                <div class="h5">Rs. {{ "%.2f"|format(cn_cgst) }}</div>
            </div>
            <div class="col-md-3">
                <div class="text-muted small">SGST Reversal</div>
                <div class="h5">Rs. {{ "%.2f"|format(cn_sgst) }}</div>
            </div>
            <div class="col-md-3">
                <div class="text-muted small">IGST Reversal</div>
                <div class="h5">Rs. {{ "%.2f"|format(cn_igst) }}</div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Section 4 - Input Tax Credit (Not tracked in this app) -->
<div class="card mb-4">
    <div class="card-header bg-secondary text-white">
        <i class="bi bi-arrow-down-circle me-1"></i>
        <strong>4. Eligible ITC (Input Tax Credit)</strong>
    </div>
    <div class="card-body">
        <div class="alert alert-warning mb-0">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Note:</strong> Input Tax Credit tracking requires purchase/expense tracking which is not implemented in this system.
            Please refer to your purchase records and GSTR-2A/2B for ITC details.
        </div>
    </div>
</div>

<!-- Net Tax Liability Summary -->
<div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
        <i class="bi bi-calculator me-1"></i>
        <strong>5. Net Tax Liability (After Credit Note Adjustments)</strong>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="p-3 bg-light rounded">
                    <div class="text-muted small">IGST Payable</div>
                    <div class="h4 text-primary mb-0">Rs. {{ "%.2f"|format(total_liability.igst) }}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-3 bg-light rounded">
                    <div class="text-muted small">CGST Payable</div>
                    <div class="h4 text-success mb-0">Rs. {{ "%.2f"|format(total_liability.cgst) }}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-3 bg-light rounded">
                    <div class="text-muted small">SGST Payable</div>
                    <div class="h4 text-info mb-0">Rs. {{ "%.2f"|format(total_liability.sgst) }}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-3 bg-light rounded">
                    <div class="text-muted small">Cess Payable</div>
                    <div class="h4 text-warning mb-0">Rs. {{ "%.2f"|format(total_liability.cess) }}</div>
                </div>
            </div>
        </div>
        <hr>
        <div class="text-center">
            <div class="text-muted">Total Tax Liability</div>
            <div class="h2 text-primary">
                Rs. {{ "%.2f"|format(total_liability.igst + total_liability.cgst + total_liability.sgst + total_liability.cess) }}
            </div>
        </div>
    </div>
</div>

<!-- Filing Instructions -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-question-circle me-1"></i>How to File GSTR-3B
    </div>
    <div class="card-body">
        <ol class="mb-0">
            <li><strong>Export Data:</strong> Click "Export Excel" to download the GSTR-3B summary</li>
            <li><strong>Login to GST Portal:</strong> Go to <a href="https://www.gst.gov.in" target="_blank">www.gst.gov.in</a></li>
            <li><strong>Navigate:</strong> Services &rarr; Returns &rarr; Returns Dashboard</li>
            <li><strong>Select Period:</strong> Choose the return period ({{ ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'][month-1] }} {{ year }})</li>
            <li><strong>File GSTR-3B:</strong> Click "Prepare Online" and enter the values from this report</li>
            <li><strong>Preview & Submit:</strong> Verify all values, preview, and file with DSC/EVC</li>
            <li><strong>Pay Tax:</strong> Pay any tax liability through "Create Challan"</li>
        </ol>
    </div>
</div>
{% endblock %}
