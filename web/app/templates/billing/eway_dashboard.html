{% extends 'base.html' %}

{% block title %}E-Way Bill Dashboard - Cosmic Surgical{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-truck me-2"></i>E-Way Bill Dashboard</h2>
    <a href="{{ url_for('billing.invoices') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Back to Invoices
    </a>
</div>

<!-- Summary Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card bg-danger text-white h-100">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle-fill display-6"></i>
                <h2 class="mt-2 mb-0">{{ total_expired }}</h2>
                <p class="mb-0">Expired</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning h-100">
            <div class="card-body text-center">
                <i class="bi bi-clock-fill display-6"></i>
                <h2 class="mt-2 mb-0">{{ total_expiring }}</h2>
                <p class="mb-0">Expiring Soon</p>
                <small>(within 24 hours)</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body text-center">
                <i class="bi bi-check-circle-fill display-6"></i>
                <h2 class="mt-2 mb-0">{{ total_valid }}</h2>
                <p class="mb-0">Valid</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-secondary text-white h-100">
            <div class="card-body text-center">
                <i class="bi bi-hourglass-split display-6"></i>
                <h2 class="mt-2 mb-0">{{ total_pending }}</h2>
                <p class="mb-0">Pending</p>
                <small>(need e-Way bill)</small>
            </div>
        </div>
    </div>
</div>

<!-- Expired E-Way Bills -->
{% if expired %}
<div class="card mb-4 border-danger">
    <div class="card-header bg-danger text-white">
        <i class="bi bi-exclamation-triangle me-1"></i>
        <strong>Expired E-Way Bills ({{ total_expired }})</strong>
        <span class="float-end">Needs immediate attention</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Invoice #</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>E-Way Bill #</th>
                        <th>Expired</th>
                        <th>Value</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in expired %}
                    <tr>
                        <td>
                            <a href="{{ url_for('billing.view_invoice', id=item.invoice.id) }}">
                                {{ item.invoice.invoice_number }}
                            </a>
                        </td>
                        <td>{{ item.invoice.invoice_date.strftime('%d-%b-%Y') }}</td>
                        <td>{{ item.invoice.customer_name or 'Walk-in' }}</td>
                        <td><code>{{ item.invoice.eway_bill_number }}</code></td>
                        <td>
                            <span class="badge bg-danger">
                                {{ item.days_expired }} day(s) ago
                            </span>
                        </td>
                        <td>Rs. {{ "%.2f"|format(item.invoice.grand_total) }}</td>
                        <td>
                            <button class="btn btn-sm btn-warning renew-eway-btn"
                                    data-invoice-id="{{ item.invoice.id }}"
                                    data-eway-number="{{ item.invoice.eway_bill_number }}">
                                <i class="bi bi-arrow-repeat me-1"></i>Renew
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Expiring Soon -->
{% if expiring_soon %}
<div class="card mb-4 border-warning">
    <div class="card-header bg-warning">
        <i class="bi bi-clock me-1"></i>
        <strong>Expiring Soon ({{ total_expiring }})</strong>
        <span class="float-end">Within 24 hours</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Invoice #</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>E-Way Bill #</th>
                        <th>Expires In</th>
                        <th>Value</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in expiring_soon %}
                    <tr>
                        <td>
                            <a href="{{ url_for('billing.view_invoice', id=item.invoice.id) }}">
                                {{ item.invoice.invoice_number }}
                            </a>
                        </td>
                        <td>{{ item.invoice.invoice_date.strftime('%d-%b-%Y') }}</td>
                        <td>{{ item.invoice.customer_name or 'Walk-in' }}</td>
                        <td><code>{{ item.invoice.eway_bill_number }}</code></td>
                        <td>
                            <span class="badge bg-warning text-dark">
                                {{ item.hours_remaining }} hour(s)
                            </span>
                        </td>
                        <td>Rs. {{ "%.2f"|format(item.invoice.grand_total) }}</td>
                        <td>
                            <a href="{{ url_for('billing.view_invoice', id=item.invoice.id) }}"
                               class="btn btn-sm btn-primary">
                                <i class="bi bi-eye me-1"></i>View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Pending E-Way Bills -->
{% if pending %}
<div class="card mb-4 border-secondary">
    <div class="card-header bg-secondary text-white">
        <i class="bi bi-hourglass-split me-1"></i>
        <strong>Pending E-Way Bills ({{ total_pending }})</strong>
        <span class="float-end">Invoices > Rs. 50,000 without e-Way bill</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Invoice #</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Value</th>
                        <th>Age</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in pending %}
                    <tr>
                        <td>
                            <a href="{{ url_for('billing.view_invoice', id=item.invoice.id) }}">
                                {{ item.invoice.invoice_number }}
                            </a>
                        </td>
                        <td>{{ item.invoice.invoice_date.strftime('%d-%b-%Y') }}</td>
                        <td>{{ item.invoice.customer_name or 'Walk-in' }}</td>
                        <td>Rs. {{ "%.2f"|format(item.invoice.grand_total) }}</td>
                        <td>
                            {% if item.days_old == 0 %}
                            <span class="badge bg-info">Today</span>
                            {% elif item.days_old == 1 %}
                            <span class="badge bg-warning">Yesterday</span>
                            {% else %}
                            <span class="badge bg-danger">{{ item.days_old }} days old</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('billing.view_invoice', id=item.invoice.id) }}"
                               class="btn btn-sm btn-success">
                                <i class="bi bi-plus-circle me-1"></i>Generate
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Valid E-Way Bills -->
{% if valid %}
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <i class="bi bi-check-circle me-1"></i>
        <strong>Valid E-Way Bills ({{ total_valid }})</strong>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Invoice #</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>E-Way Bill #</th>
                        <th>Valid Until</th>
                        <th>Days Left</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in valid %}
                    <tr>
                        <td>
                            <a href="{{ url_for('billing.view_invoice', id=item.invoice.id) }}">
                                {{ item.invoice.invoice_number }}
                            </a>
                        </td>
                        <td>{{ item.invoice.invoice_date.strftime('%d-%b-%Y') }}</td>
                        <td>{{ item.invoice.customer_name or 'Walk-in' }}</td>
                        <td><code>{{ item.invoice.eway_bill_number }}</code></td>
                        <td>
                            {% if item.invoice.eway_bill_valid_until %}
                            {{ item.invoice.eway_bill_valid_until.strftime('%d-%b-%Y %H:%M') }}
                            {% else %}
                            <span class="text-muted">Not set</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.days_remaining is not none %}
                            <span class="badge bg-success">{{ item.days_remaining }} day(s)</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('billing.view_invoice', id=item.invoice.id) }}"
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye me-1"></i>View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- No Data Message -->
{% if not expired and not expiring_soon and not valid and not pending %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-truck display-1 text-muted"></i>
        <h4 class="mt-3">No E-Way Bills Found</h4>
        <p class="text-muted">E-Way bills will appear here once you create invoices over Rs. 50,000</p>
        <a href="{{ url_for('billing.new_bill') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i>Create New Invoice
        </a>
    </div>
</div>
{% endif %}

<!-- Help Section -->
<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-question-circle me-1"></i>E-Way Bill Information
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>When is E-Way Bill Required?</h6>
                <ul class="small text-muted">
                    <li>For movement of goods valued above Rs. 50,000</li>
                    <li>For both inter-state and intra-state movement</li>
                    <li>Before goods are moved from the place of supply</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>E-Way Bill Validity</h6>
                <ul class="small text-muted">
                    <li><strong>Regular Cargo:</strong> 1 day per 100 km or part thereof</li>
                    <li><strong>Over Dimensional Cargo:</strong> 1 day per 20 km or part thereof</li>
                    <li>Validity starts from date & time of generation</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle renewal button click
    document.querySelectorAll('.renew-eway-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const invoiceId = this.dataset.invoiceId;
            const ewayNumber = this.dataset.ewayNumber;

            if (confirm(`Are you sure you want to renew E-Way Bill ${ewayNumber}?\n\nThis will clear the current e-Way bill and allow you to generate a new one on the GST portal.`)) {
                fetch(`/billing/invoices/${invoiceId}/eway-bill/renew`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        window.location.href = data.redirect;
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while renewing the e-Way bill');
                });
            }
        });
    });
});
</script>
{% endblock %}
