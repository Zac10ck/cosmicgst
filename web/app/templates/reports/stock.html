{% extends 'base.html' %}

{% block title %}Stock Report - GST Billing{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-box-seam me-2"></i>Stock Report</h2>
    <div>
        <a href="{{ url_for('reports.export_stock') }}" class="btn btn-success me-2">
            <i class="bi bi-download me-1"></i>Export Excel
        </a>
        <a href="{{ url_for('reports.index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Back
        </a>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 opacity-75">Total Stock Value</h6>
                <h3 class="card-title mb-0">Rs. {{ "%.2f"|format(total_stock_value) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 opacity-75">Total Products</h6>
                <h3 class="card-title mb-0">{{ total_items }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 opacity-75">Low Stock Items</h6>
                <h3 class="card-title mb-0">{{ low_stock_count }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Search</label>
                <input type="text" class="form-control" name="search" placeholder="Product name, barcode..."
                       value="{{ search }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Category</label>
                <select class="form-select" name="category">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}" {{ 'selected' if category_id == cat.id }}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Stock Status</label>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" name="low_stock" value="1"
                           id="low-stock" {{ 'checked' if low_stock }}>
                    <label class="form-check-label" for="low-stock">
                        Show Low Stock Only
                    </label>
                </div>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-filter me-1"></i>Filter
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Stock List -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Product</th>
                        <th>Barcode</th>
                        <th>HSN</th>
                        <th>Category</th>
                        <th class="text-center">Stock</th>
                        <th class="text-center">Low Alert</th>
                        <th class="text-end">Price</th>
                        <th class="text-end">Stock Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr class="{{ 'table-danger' if product.stock_qty <= product.low_stock_alert }}">
                        <td>
                            <strong>{{ product.name }}</strong>
                            {% if product.stock_qty <= product.low_stock_alert %}
                            <span class="badge bg-danger ms-1">Low Stock</span>
                            {% endif %}
                        </td>
                        <td><code>{{ product.barcode or '-' }}</code></td>
                        <td>{{ product.hsn_code or '-' }}</td>
                        <td>{{ product.category.name if product.category else '-' }}</td>
                        <td class="text-center">
                            <strong>{{ "%.2f"|format(product.stock_qty) }}</strong> {{ product.unit }}
                        </td>
                        <td class="text-center">{{ product.low_stock_alert }} {{ product.unit }}</td>
                        <td class="text-end">Rs. {{ "%.2f"|format(product.price) }}</td>
                        <td class="text-end"><strong>Rs. {{ "%.2f"|format(product.stock_qty * product.price) }}</strong></td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                            <p class="mt-2 mb-0">No products found</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if products %}
                <tfoot class="table-primary">
                    <tr>
                        <td colspan="7" class="text-end"><strong>Total Stock Value</strong></td>
                        <td class="text-end"><strong>Rs. {{ "%.2f"|format(total_stock_value) }}</strong></td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>
    <div class="card-footer text-muted">
        Showing {{ products|length }} product(s)
    </div>
</div>
{% endblock %}
